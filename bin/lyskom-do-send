#!/bin/sh -x
# argument lyskom.el [lyskom.elc]
# Detta {r en enklare variant av lyskom-send som f|ruts{tter att man st}r
# i ett iordninggjort dir.
#
# m -- Man f}r bara ett meddelande om att en ny version av klienten
#      {r distribuerad.
# P -- PARTS.xx {r distributionen d{r delarna {r var f|r sig
# A -- ALL.xx {r lyskom.el sharad
# adir -- lyskom.el uuencodedad.
# B -- BYTEC.xx {r lyskom.elc sharad
# udir -- lyskom.elc {r obel18 versionen av klienten med r{tt skyddskod.
# D -- DOC.xx {r klientdocumentationen sharad.
# ddir -- elisp-client.txt {r klientdocumentationen.
# I -- IDOC.xx {r klientdocumentationen sharad.
# idir -- elisp-client {r klientdocumentationen info-format.
#
# $Id: lyskom-do-send,v 35.3 1992-01-25 01:19:35 linus Exp $
# Copyright (C) 1991  Lysator Academic Computer Association.
#
# This file is part of the LysKOM server.
# 
# LysKOM is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by 
# the Free Software Foundation; either version 1, or (at your option) 
# any later version.
# 
# LysKOM is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
# 
# You should have received a copy of the GNU General Public License
# along with LysKOM; see the file COPYING.  If not, write to
# Lysator, c/o ISY, Linkoping University, S-581 83 Linkoping, SWEDEN,
# or the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, 
# MA 02139, USA.
#
# Please mail bug reports to bug-lyskom@lysator.liu.se. 
#

maillist=../../lib/mailing-do-list

set -- `getopt m: $*`
if [ $1 != -- ]
then
# just sending an announcement message

	recipients=`
	while read status options
	do
		if [ X$status != XACTIVE ]
		then continue
		fi
		set -- \`getopt mBCLOU: $options\`
		while [ $1 != -- ]
		do
			shift;
		done
		echo $2
	done < $maillist`

	if [ $2 = - ]
	then
		echo Recipients: $recipients
		echo Type your message. End with EOF
		messagefile=/tmp/lyskom-message
		cat > $messagefile
		temps="$messagefile $temps"
	else
		messagefile=$2
	fi
	echo Mailing message to $recipients
	Mail -s "Message on the lyskom source list" $recipients < $messagefile

	rm $temps
	exit;
fi

shift

while read status options
do
	if [ X$status != XACTIVE ]
	then continue
	fi

	message=
	files=
	all=
	udir=
	doc=
	idoc=

	set -- `getopt mPBu:Aa:Dd:Ii: $options`
# defaults
	while [ $1 != -- ]
	do
		case $1 in
		-m) message=true;;
		-P) files="$files `echo PARTS.*`" ;;
	 	-B) files="$files `echo BYTEC.*`" ;;
		-u) shift;
		    udir=$1 ;;
		-A) files="$files `echo ALL.*`" ;;
		-a) shift;
		    all=$1 ;;
		-D) files="$files `echo DOC.*`" ;;
		-d) shift;
		    doc=$1;;
		-I) files="$files `echo IDOC.*`" ;;
		-i) shift;
		    idoc=$1;;
		esac
		shift
	done
	
	shift


	echo sending to $1

	if [ X$message = Xtrue ]
	then
		VER=`grep "lyskom-clientversion " vars.el | \
	sed -n 's/^.*defconst.*lyskom-clientversion[^"]*"\([^"]*\)".*$/\1/p'`
		Mail -s "lyskom-elispklienten version $VER ute nu" $1 <<EOM
Det finns nu en ny version av elisp-klienten att h{mta fr}n lysators
ftparea ftp.lysator.liu.se under i dirret /pub/lyskom/elisp-client/

Filerna heter: lyskom-$VER.el.Z
               lyskom-$VER.elc.Z
Dokumentation: elisp-client-$VER.txt.Z
EOM
	fi

	for file in $files --
	do
		if [ $file != -- ] 
		then
			Mail -s $file $1 < $file ;
		fi
	done
	
	if [ X$all != X ] 
	then
		uuencode lyskom.el ${all}lyskom.el | Mail -s lyskom.el $1;
	fi
	if [ X$udir != X ] 
	then
		uuencode lyskom.elc ${udir}lyskom.elc | Mail -s lyskom.elc $1;
	fi
	if [ X$doc != X ] 
	then
		file=elisp-client.txt;
		uuencode $file ${doc}$file | Mail -s $file $1;
	fi
	if [ X$idoc != X ] 
	then
		file=elisp-client;
		uuencode $file ${idoc}$file | Mail -s $file $1;
	fi
done < $maillist

